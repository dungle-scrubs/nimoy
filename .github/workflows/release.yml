name: Release

on:
  push:
    branches: [main]

permissions:
  contents: write
  pull-requests: write

jobs:
  release-please:
    runs-on: ubuntu-latest
    outputs:
      release_created: ${{ steps.release.outputs.release_created }}
      tag_name: ${{ steps.release.outputs.tag_name }}
      version: ${{ steps.release.outputs.version }}
    steps:
      - uses: googleapis/release-please-action@v4
        id: release
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

  build:
    needs: release-please
    if: needs.release-please.outputs.release_created == 'true'
    runs-on: macos-15
    strategy:
      matrix:
        arch: [arm64, x86_64]
    steps:
      - uses: actions/checkout@v6

      - name: Build release archive
        run: |
          xcodebuild archive \
            -project Nimoy.xcodeproj \
            -scheme Nimoy \
            -configuration Release \
            -destination 'generic/platform=macOS' \
            -archivePath build/Nimoy.xcarchive \
            ARCHS=${{ matrix.arch }} \
            ONLY_ACTIVE_ARCH=NO \
            CODE_SIGNING_ALLOWED=NO \
            SKIP_INSTALL=NO

      - name: Export app bundle
        run: |
          mkdir -p dist
          cp -R build/Nimoy.xcarchive/Products/Applications/Nimoy.app dist/

      - name: Create zip
        run: |
          cd dist
          zip -r -y ../Nimoy-${{ needs.release-please.outputs.tag_name }}-darwin-${{ matrix.arch }}.zip Nimoy.app

      - uses: actions/upload-artifact@v4
        with:
          name: Nimoy-darwin-${{ matrix.arch }}
          path: Nimoy-${{ needs.release-please.outputs.tag_name }}-darwin-${{ matrix.arch }}.zip

  upload:
    needs: [release-please, build]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/download-artifact@v4

      - name: Upload release assets
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release upload "${{ needs.release-please.outputs.tag_name }}" \
            Nimoy-darwin-arm64/*.zip \
            Nimoy-darwin-x86_64/*.zip \
            --repo "${{ github.repository }}"

  update-cask:
    needs: [release-please, upload]
    runs-on: ubuntu-latest
    steps:
      - name: Update Homebrew cask
        env:
          GH_TOKEN: ${{ secrets.HOMEBREW_TAP_TOKEN }}
        run: |
          VERSION="${{ needs.release-please.outputs.version }}"
          TAG="${{ needs.release-please.outputs.tag_name }}"

          # Download arm64 zip to compute SHA
          curl -L -o nimoy-arm64.zip \
            "https://github.com/${{ github.repository }}/releases/download/${TAG}/Nimoy-${TAG}-darwin-arm64.zip"
          ARM_SHA=$(shasum -a 256 nimoy-arm64.zip | cut -d' ' -f1)

          # Download x86_64 zip to compute SHA
          curl -L -o nimoy-x86.zip \
            "https://github.com/${{ github.repository }}/releases/download/${TAG}/Nimoy-${TAG}-darwin-x86_64.zip"
          X86_SHA=$(shasum -a 256 nimoy-x86.zip | cut -d' ' -f1)

          # Clone tap repo
          git clone "https://x-access-token:${GH_TOKEN}@github.com/dungle-scrubs/homebrew-nimoy.git" tap
          cd tap

          # Update cask
          cat > Casks/nimoy.rb << EOF
          cask "nimoy" do
            version "${VERSION}"

            on_arm do
              url "https://github.com/dungle-scrubs/nimoy/releases/download/v#{version}/Nimoy-v#{version}-darwin-arm64.zip"
              sha256 "${ARM_SHA}"
            end

            on_intel do
              url "https://github.com/dungle-scrubs/nimoy/releases/download/v#{version}/Nimoy-v#{version}-darwin-x86_64.zip"
              sha256 "${X86_SHA}"
            end

            name "Nimoy"
            desc "Calculator notebook for macOS"
            homepage "https://github.com/dungle-scrubs/nimoy"

            depends_on macos: ">= :sonoma"

            app "Nimoy.app"

            zap trash: [
              "~/Library/Preferences/com.nimoy.app.plist",
              "~/Library/Caches/com.nimoy.app",
            ]
          end
          EOF

          # Remove leading whitespace from heredoc
          sed -i 's/^          //' Casks/nimoy.rb

          git config user.name github-actions
          git config user.email github-actions@github.com
          git add Casks/nimoy.rb
          git diff --staged --quiet || git commit -m "chore: update nimoy to ${VERSION}"
          git push origin main

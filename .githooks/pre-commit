#!/bin/bash
# Pre-commit hook for Nimoy
# Runs: SwiftFormat, SwiftLint, Type checking (build)

set -e

echo "ğŸ”§ Running pre-commit checks..."

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Get staged Swift files
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep '\.swift$' || true)

if [ -z "$STAGED_FILES" ]; then
    echo "ğŸ“ No Swift files staged, skipping checks."
    exit 0
fi

echo "ğŸ“ Checking $(echo "$STAGED_FILES" | wc -l | tr -d ' ') Swift file(s)..."

# 1. SwiftFormat - Auto-fix formatting
echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "ğŸ“ Running SwiftFormat..."
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

if command -v swiftformat &> /dev/null; then
    echo "$STAGED_FILES" | xargs swiftformat --config .swiftformat 2>&1 || {
        echo -e "${RED}âŒ SwiftFormat failed${NC}"
        exit 1
    }
    # Re-add formatted files
    echo "$STAGED_FILES" | xargs git add
    echo -e "${GREEN}âœ“ Formatting complete${NC}"
else
    echo -e "${YELLOW}âš ï¸  SwiftFormat not installed. Run: brew install swiftformat${NC}"
fi

# 2. SwiftLint - Check for issues
echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "ğŸ” Running SwiftLint..."
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

if command -v swiftlint &> /dev/null; then
    LINT_RESULT=$(echo "$STAGED_FILES" | xargs swiftlint lint --quiet --config .swiftlint.yml 2>&1) || true
    
    if [ -n "$LINT_RESULT" ]; then
        echo "$LINT_RESULT"
        
        # Count errors vs warnings
        ERROR_COUNT=$(echo "$LINT_RESULT" | grep -c "error:" || true)
        WARNING_COUNT=$(echo "$LINT_RESULT" | grep -c "warning:" || true)
        
        if [ "$ERROR_COUNT" -gt 0 ]; then
            echo ""
            echo -e "${RED}âŒ SwiftLint found $ERROR_COUNT error(s). Please fix before committing.${NC}"
            exit 1
        fi
        
        if [ "$WARNING_COUNT" -gt 0 ]; then
            echo ""
            echo -e "${YELLOW}âš ï¸  SwiftLint found $WARNING_COUNT warning(s). Consider fixing.${NC}"
        fi
    else
        echo -e "${GREEN}âœ“ No lint issues${NC}"
    fi
else
    echo -e "${YELLOW}âš ï¸  SwiftLint not installed. Run: brew install swiftlint${NC}"
fi

# 3. Type checking via build
echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "ğŸ”¨ Running type check (build)..."
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

# Quick build to check for type errors (clean build to avoid cache issues)
BUILD_OUTPUT=$(xcodebuild -scheme Nimoy -configuration Debug build -destination 'platform=macOS' 2>&1)
BUILD_EXIT_CODE=$?

# Check for errors in output OR non-zero exit code
if [ $BUILD_EXIT_CODE -ne 0 ] || echo "$BUILD_OUTPUT" | grep -q "error:"; then
    echo -e "${RED}âŒ Build failed with errors:${NC}"
    echo "$BUILD_OUTPUT" | grep -E "error:" | head -20
    exit 1
fi

echo -e "${GREEN}âœ“ Type check passed${NC}"

# 4. Check for missing documentation (optional - just warn)
echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "ğŸ“š Checking documentation..."
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

# Count public functions without docs
UNDOCUMENTED=$(echo "$STAGED_FILES" | xargs grep -l "^\s*public\s*func\|^\s*func" 2>/dev/null | while read file; do
    # Look for functions not preceded by /// or /**
    awk '
        /^[[:space:]]*(public[[:space:]]+)?func[[:space:]]/ {
            if (prev !~ /\/\/\/|\/\*\*/) {
                print FILENAME ":" NR ": " $0
            }
        }
        { prev = $0 }
    ' "$file"
done | head -10)

if [ -n "$UNDOCUMENTED" ]; then
    echo -e "${YELLOW}âš ï¸  Some functions may be missing documentation:${NC}"
    echo "$UNDOCUMENTED"
    echo ""
    echo "Consider adding /// documentation comments."
else
    echo -e "${GREEN}âœ“ Documentation looks good${NC}"
fi

echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo -e "${GREEN}âœ… All pre-commit checks passed!${NC}"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
exit 0
